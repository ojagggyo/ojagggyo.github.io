<!doctype html>
<html lang="en">
<head>
    <title>Steem Power</title>
    <meta charset="utf-8">
    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
    <script src="https://github.com/steemit/steem-js/releases/download/v0.7.7/steem.min.js"></script>
    <script>let username;
            function saveUserName(){
                username = window.location.hash;// #username
                if (username == null || username.trim().length == 0){
                    username = "#steemitblog";
                }

                username = username.substr(1);//#を取る
                username = decodeURI(username).trim();//デコード、トリム
            }

            async function getSteemPower() {
                let steemPrice = await steem.api.getCurrentMedianHistoryPriceAsync();
                console.log(steemPrice);
                steemPrice = parseFloat(steemPrice.base.replace(" SBD"));

                let accounts = await steem.api.getAccountsAsync([username]);
                console.log(accounts);
                if (accounts.length == 0) { return; }
                let item = accounts[0];

                // RSHARE
                let globalProperties = await steem.api.getDynamicGlobalPropertiesAsync();
                console.log(globalProperties);
                let total_vesting_shares = parseFloat(globalProperties.total_vesting_shares.replace(" VESTS", ""));
                let total_vesting_fund_steem = parseFloat(globalProperties.total_vesting_fund_steem.replace(" STEEM", ""));

                let vesting_shares = parseFloat(item.vesting_shares.replace(" VESTS", ""));
                let received_vesting_shares = parseFloat(item.received_vesting_shares.replace(" VESTS", ""));
                let delegated_vesting_shares = parseFloat(item.delegated_vesting_shares.replace(" VESTS", ""));
                let sumVestingShare = vesting_shares + received_vesting_shares - delegated_vesting_shares;
               
                let sp = (sumVestingShare / total_vesting_shares * total_vesting_fund_steem);
                $("#steemPower").text("Steem Powerは " + sp.toFixed(6) + " SPです。");

                let sp1 = (vesting_shares / total_vesting_shares * total_vesting_fund_steem);
                let sp2 = (received_vesting_shares / total_vesting_shares * total_vesting_fund_steem);
                let sp3 = (delegated_vesting_shares / total_vesting_shares * total_vesting_fund_steem);
                
                $("#detail").text(sp1.toFixed(6) +" - "+ sp2.toFixed(6) +" + "+sp3.toFixed(6));
            }

            window.onload = function() {
                steem.api.setOptions({url: 'https://api.steemit.com'});
                saveUserName();
                getSteemPower();

                setInterval(getSteemPower, 1000);
            };</script>
</head>
<body>
    <div>
        こんにちは、
    </div>
    <h1 id="steemPower"></h1>
    <h1 id="detail"></h1>
</body>
</html>
