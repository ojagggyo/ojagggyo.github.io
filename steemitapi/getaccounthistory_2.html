<!doctype html>
<html lang="en">
    <head>
        <title>getaccounthistory</title>
        <meta charset="utf-8">
        <script src="https://github.com/steemit/steem-js/releases/download/v0.7.7/steem.min.js"></script>
        <!-- <script src="https://ojagggyo.github.io/steemitapi/getaccounthistory.js"></script> -->
      
<script>
	
steem.api.setOptions({url: 'https://api.steemit.com'})
let _stok;
_sbd_payout = {};
_vesting_payout = {};
_sbd_payout_count = {};
_payout = [];
	

		
function makeTable(records){

	//console.log(records);
	html = '<table border=1 >';
	//テーブルのヘッダー
	html = html + '<tr>';
	html = html + '<th></th><th>name</th><th>sbd_payout</th><th>sp_payout</th><th>count</th>';
	html = html + '</tr>';
	for(var i=0;i<records.length;i=i+1){
		html = html + '<tr>';
		html = html + '<td align=right>' + (i+1) + '</td>';
		html = html + '<td>' + records[i].name + '</td>';
		html = html + '<td align=right>' + records[i].sbd_payout.toFixed(3) + '</td>';
		html = html + '<td align=right>' + records[i].sp.toFixed(3) + '</td>';
		html = html + '<td align=right>' + records[i].count + '</td>';

		html = html + '</tr>';
	}
	html = html + '</table>';
	//console.log(html);
	document.getElementById("text").innerHTML = html;
}

		
async function aaa(){
	
	 document.getElementById("text").innerHTML = '<tabel></tabel>';
	
	_sbd_payout = {};
	_sbd_payout_count = {};
	_vesting_payout = {};
	_payout = [];
	
	
	let out = [];
	let limit = 100;
	let lastlength = limit;
	let firstValue = -1;
  	let firstTimestamp = new Date();
	let benefactor = document.getElementById("text1").value;
	let now = new Date();
	while (lastlength == limit && now - firstTimestamp <= (86400000 * 7)){
		
		document.getElementById("progress").innerText = firstTimestamp;
		console.log(firstTimestamp);
		
		let ret = await steem.api.getAccountHistoryAsync(benefactor, firstValue, limit);
		//console.log(ret);		
		firstValue = ret[0][0];
    		firstTimestamp = new Date(ret[0][1].timestamp);
		firstTimestamp.setHours(firstTimestamp.getHours() + 9);
		ret.shift();
		lastlength = ret.length;
		
		
		for(var i=ret.length-1;i>=0;i=i-1){
			if(ret[i][1].op[0] != "comment_benefactor_reward"){ret.splice(i,1);continue;}
			if(ret[i][1].op[1].benefactor != benefactor){ret.splice(i,1);continue;}
			if(now - (ret[i][1].timestamp + 3600000 * 9) > (86400000 * 7)){
				ret.splice(i,1);
				continue;
			}
					
			let author = ret[i][1].op[1].author;
			let sbd_payout = parseFloat(ret[i][1].op[1].sbd_payout.slice(0,-4));//" SBD"を除く
			let vesting_payout = parseFloat(ret[i][1].op[1].vesting_payout);
			if(_sbd_payout[author] === void 0){
				_sbd_payout[author] = sbd_payout;
				_sbd_payout_count[author] = 1;
				_vesting_payout[author] = vesting_payout;
			}else{
				_sbd_payout[author] += sbd_payout;
				_sbd_payout_count[author] += 1;
				_vesting_payout[author] += vesting_payout;
			}
		}
		
		out = ret.concat(out);
	}
	
	
	Object.keys(_sbd_payout).forEach(function (key) {
	  	//console.log(key + " " + _sbd_payout[key] );
		let payout = {};
		payout['name'] = key;
		payout['sbd_payout'] = _sbd_payout[key];
		payout['vesting_payout'] = _vesting_payout[key];
		payout['count'] = _sbd_payout_count[key];
		_payout.push(payout);
	});
	
	//vestToSteem
	let globalProperties = await steem.api.getDynamicGlobalPropertiesAsync();	
	for(let i=0; i<_payout.length; i++){
		_payout[i]['sp'] = steem.formatter.vestToSteem(
			_payout[i].vesting_payout, 
			globalProperties.total_vesting_shares, 
			globalProperties.total_vesting_fund_steem)
	}
	
	//sort
	if(_payout.length > 1) {
		_payout = _payout.sort(function(a,b){
			if(a.sbd_payout < b.sbd_payout) return 1;
			if(a.sbd_payout > b.sbd_payout) return -1;
			return 0;
		});
	}
	
	//console.log(out);
	return out;
};



function clickBtn(){
	aaa().then(result => {		
		makeTable(_payout);
		//_stok = result;
	}).catch(err => {
		console.log('☆');
		console.log(err);
	});
}  
      
</script>
      
    </head>
    <body>        
        <p>報酬の寄付を表示します。</p>
	<input type="text" id="text1" size="20" value=japansteemit> <input type="button" value="表示する" onclick="clickBtn()" />
	<br/>
	<a id="progress"></a>
        <br/>
        <span id="text"></span>
    </body>
</html>
