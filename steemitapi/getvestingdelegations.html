<!doctype html>
<html lang="en">
    <head>
        <title>getvestingdelegations</title>
        <meta charset="utf-8">
        <script src="https://github.com/steemit/steem-js/releases/download/v0.7.7/steem.min.js"></script>
        <!-- <script src="https://ojagggyo.github.io/steemitapi/getvestingdelegations.js"></script> -->
      
<script>

	//<a href=javascript:clickTableHeader();>min_delegation_time</a>
	
steem.api.setOptions({url: 'https://api.steemit.com'})
let _stok;
	
function donokuraimae(date){
	date1 = new Date(date);
	date1.setHours(date1.getHours() + 9);
	var now = new Date();
	sa = now - date1;
	if(sa >= 86400000){return Math.floor(sa / 86400000)+'日前';}
	if(sa >= 3600000){return Math.floor(sa / 3600000)+'時間前';}
	if(sa >= 60000){return Math.floor(sa / 60000)+'分前';}
	if(sa >= 1000){return Math.floor(sa / 1000)+'秒前';}
	return 'たった今';
}
		
function makeTable(records){

	console.log('☆records☆');
	console.log(records);
	html = '<table border=1 >';
	//テーブルのヘッダー
	html = html + '<tr>';
	html = html + '<th></th><th>delegatee</th><th>min_delegation_time</th><th>vesting_shares</th>';
	html = html + '</tr>';
	for(var i=0;i<records.length;i=i+1){
		html = html + '<tr>';
		html = html + '<td align=right>' + (i+1) + '</td>';
		html = html + '<td>' + records[i].delegatee + '</td>';
		html = html + '<td align=right>' + donokuraimae(records[i].min_delegation_time) + '</td>';
		html = html + '<td align=right>' + records[i].sp + '</td>';		
		html = html + '</tr>';
	}
	html = html + '</table>';
	console.log(html);
	document.getElementById("text").innerHTML = html;
}
		
async function aaa(){
	let out = [];
	let limit = 2;
	let lastlength = limit;
	let lastDelegatee = "";
	let author = document.getElementById("text1").value;
	while (lastlength == limit){
		if (out.length > 0) limit = 2 + 1;
		let ret = await steem.api.getVestingDelegationsAsync(author, lastDelegatee, limit);
		console.log(ret);		
		lastlength = ret.length;
		lastDelegatee = ret[ret.length - 1].delegatee;
		out.pop();
		out = out.concat(ret);
	}
	console.log("☆");
	console.log(out);

	
	let globalProperties = await steem.api.getDynamicGlobalPropertiesAsync();
  	console.log(globalProperties);
	let totalVestingShares = parseFloat(globalProperties.total_vesting_shares.replace(" VESTS", ""));
	let totalVestingFundSteem = parseFloat(globalProperties.total_vesting_fund_steem.replace(" STEEM", ""));
	//let k = total_vesting_fund_steem / total_vesting_shares;	
	for(let i=0; i<out.length; i++){
		records[i]['sp'] = steem.formatter.vestToSteem(records[i].vesting_shares, totalVestingShares, totalVestingFundSteem)
	}
	
	return out;
};

/*function clickTableHeader(){
	if(_stok.length < 2) return;
	(_stok[0].reputation > _stok[_stok.length - 1].reputation) ? k = -1 : k = 1;
	_stok = _stok.sort(function(a,b){
		if(a.reputation < b.reputation) return k;
		if(a.reputation > b.reputation) return -k;
		return 0;
	});
	makeTable(_stok);
}*/

function clickBtn(){
	aaa().then(result => {		
		makeTable(result);
		_stok = result;
	}).catch(err => {
		console.log('☆');
		console.log(err);
	});
}  
      
</script>
      
    </head>
    <body>        
        <p>デリゲーションを表示します。</p>
	<input type="text" id="text1" size="20" value=yasu> <input type="button" value="表示する" onclick="clickBtn()" />
	<a id="progress"></a>
        <br/>
        <span id="text"></span>
    </body>
</html>
