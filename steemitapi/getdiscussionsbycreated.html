<!doctype html>
<html lang="en">
    <head>
        <title>getdiscussionsbycreated</title>
        <meta charset="utf-8">
        <script src="https://github.com/steemit/steem-js/releases/download/v0.7.7/steem.min.js"></script>
	    
<style type="text/css">
img {
width: 32px;
height: 32px;
object-fit: cover;
}
</style>
	    
<script>
	
function donokuraimae(date){
	date1 = new Date(date);
	date1.setHours(date1.getHours() + 9);
	var now = new Date();
	sa = now - date1;
	if(sa >= 86400000){return Math.floor(sa / 86400000)+'日前';}
	if(sa >= 3600000){return Math.floor(sa / 3600000)+'時間前';}
	if(sa >= 60000){return Math.floor(sa / 60000)+'分前';}
	if(sa >= 1000){return Math.floor(sa / 1000)+'秒前';}
	return 'たった今';
}

function getTags(json_string){
  const json = JSON.parse(json_string);
  if ('tags' in json) {
    //return json.tags.join(' ');
	return json.tags.map(tag => "#" + tag).join(' ');
  }
  return '';  
}
	
function getImages(json_string){
  const json = JSON.parse(json_string);
  if ('image' in json) {
	let html = "";
	for(let i=0; i<json.image.length; i=i+1){	   
	  html = html + "<img src=https://steemitimages.com/32x32/" + json.image[i] + " loading=lazy />";
		//html = html + "<img src=" + json.image[i] + " width=40 height=40 loading=lazy />";
	}
    	return html;
  }
  return '';  
}	
	
steem.api.setOptions({url: 'https://api.steemit.com'})
lastauthor = "";
lastpermlink = "";
discussions = [];
limit = 10;
	
async function aaa(){
	let query = { limit : 10, tag : "hive-161179" };
	query["limit"] = limit;
	query["start_author"] = lastauthor;
	query["start_permlink"] = lastpermlink;
	let ret = steem.api.getDiscussionsByCreatedAsync(query);
	console.log(ret);
	return ret;
};
		
function clickBtn(){
	console.log(lastauthor);
	console.log(lastpermlink);
	
	aaa().then(result => {
		makeTable(result);
	}).catch(err => {
		console.log('☆');
		console.log(err);
	});
}


	
function makeTable(result){

	console.log('☆result☆');
	console.log(result);

	if(lastauthor != ''){
		result.shift();//配列の先頭を削除
	}
	
	if(result.length > 0){
		lastauthor = result[result.length - 1].author;//最後の要素を保存
		lastpermlink = result[result.length - 1].permlink;//最後の要素を保存
		limit = 11;
	}
	
	
	discussions = discussions.concat(result);//合体
	
	
	html = '<table border=1 >';
	//テーブルのヘッダー
	html = html + '<tr>';
	html = html + '<th></th><th>author</th><th>title</th><th>beneficiaries</th><th>tags</th>';
	html = html + '</tr>';
	for(let i=0; i<discussions.length; i=i+1){
		
		
		html = html + '<tr>';
		html = html + '<td align=right>' + donokuraimae(discussions[i].created) + '</td>';//
		html = html + '<td>' + discussions[i].author + '</td>';
		html = html + '<td><a href=' + 'https://steemit.com' + discussions[i].url + ' target=_blank>' + discussions[i].title + '</a>'
		+ '<br/>' + getImages(discussions[i].json_metadata) + '</td>';
		html = html + '<td>';
		
		for(let j=0; j<discussions[i].beneficiaries.length; j++){
			html = html + discussions[i].beneficiaries[j].account + ' ';
			html = html + discussions[i].beneficiaries[j].weight.toString().slice(0,-2) + '%';
			html = html + '<br/>';
		}
		
		html = html + '</td>';
		html = html + '<td>' + getTags(discussions[i].json_metadata) + '</td>';
		html = html + '</tr>';
		console.log("☆" + i);
	}
	html = html + '</table>';
	//console.log(html);
	document.getElementById("text").innerHTML = html;
}
	

window.onload = function() {
lastauthor = "";
lastpermlink = "";
discussions.length = 0;//配列の初期化
	

    //clickBtn();
};
	

        </script>
    </head>
    <body>        
        <p>ディスカッションを表示します。</p>
        <span id="text"></span>
        <!-- <script src="https://ojagggyo.github.io/steemitapi/gettrendingtags.js"></script> -->
	    
<input type="button" value="もっと見る" onclick="clickBtn()" />
    </body>
</html>

