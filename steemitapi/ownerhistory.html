<!doctype html>
<html lang="en">
    <head>
        <title>ownerhistory</title>
        <meta charset="utf-8">
        <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
        <script src="https://github.com/steemit/steem-js/releases/download/v0.7.7/steem.min.js"></script>
        <!-- <script src="https://ojagggyo.github.io/steemitapi/ownerhistory.js"></script> -->
        <script>
        function ConvertDate(datetime){
  time = new Date(datetime);
  time.setHours(time.getHours() + 9);
  return time.toLocaleString().slice(0,-3);
}

steem.api.setOptions({url: 'https://api.steemit.com'});    

async function getAccountInfo(usernames){
  let data =[];
  
  for(var i=0;i<usernames.length;i=i+1){
    
    let accounts = await steem.api.getAccountsAsync([usernames[i]]);
    if(accounts.length == 0) return;//アカウントなし
    console.log(accounts[0]);
    let ownerHistory = await steem.api.getOwnerHistoryAsync(usernames[i]);
    console.log('☆☆');
    data.push({'n':usernames[i],'a':accounts[0],'v':ownerHistory}); 
  }
  
  console.log(data);
  return data;
}

function clickBtn() {
  let t1 = document.getElementById("text1").value;
  let csv = t1.split(/\n/);//改行で分割する
  
  getAccountInfo(csv).then(result => {
     console.log('★');
    console.log(result);
    html = '<table>';
    html = html + '<tr>';
    html = html + '<th>Name</th><th>recovery_account</th><th>last_owner_update</th><th>withdraw_routes</th><th>last_valid_time</th><th>Power Down</th>';
    html = html + '</tr>';
    
    for(var i=0;i<result.length;i=i+1){
      
      html = html + '<tr>';
      
      html = html + '<td>';
      html = html + csv[i];
      html = html + '</td>';
      
      html = html + '<td>';
      html = html + result[i].a.recovery_account;
      html = html + '</td>';
      
      html = html + '<td>';
        console.log(result[i].a.last_owner_update.toString());
      if(result[i].a.last_owner_update.toString() != '1970-01-01T00:00:00'){
        html = html + ConvertDate(result[i].a.last_owner_update);
      }
      html = html + '</td>';
        
      html = html + '<td>';
      if(result[i].a.withdraw_routes > 0){
        html = html + result[i].a.withdraw_routes;          
      }
      html = html + '</td>';
       
        
      html = html + '<td>';
      if(result[i].v.length > 0){
        console.log(result[i].v[0]);
        html = html + ConvertDate(result[i].v[0].last_valid_time);
      }
      html = html + '</td>';

      html = html + '<td>';
      if(result[i].a.to_withdraw > 0){
        html = html + (result[i].a.to_withdraw / parseFloat(result[i].a.vesting_shares.slice(0,-6)) /10000).toFixed(2) + '%';// 1000000/100
      }
      html = html + '</td>';
        
      html = html + '</tr>';
    }
    html = html + '</table>';
    console.log(html);
    document.getElementById("text").innerHTML = html;
  }).catch(err => {
     console.log('☆');
    console.log(err);
  }); 


}

        </script>
    </head>
    <body>        
        <p>アカウント名を入力してください。</p>
        <textarea id="text1" rows="10" cols="20">support-jp</textarea>
        <br/>
        <input type="button" value="検査する" onclick="clickBtn()" />
        
        <span id="text"></span>
    </body>
</html>
