<!doctype html>
<html lang="en">
    <head>
        <title>ownerhistory</title>
        <meta charset="utf-8">
        <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
        <script src="https://github.com/steemit/steem-js/releases/download/v0.7.7/steem.min.js"></script>
        <!-- <script src="https://ojagggyo.github.io/steemitapi/ownerhistory.js"></script> -->
        
        <script>
          
const sleep = ms => new Promise(res => setTimeout(res, ms));
              
function ConvertDate(datetime){
    time = new Date(datetime);
    time.setHours(time.getHours() + 9);
    return time.toLocaleString().slice(0,-3);
}

steem.api.setOptions({url: 'https://api.steemit.com'});    

async function getAccountInfo(usernames){
  let data =[];

  document.getElementById("text").innerHTML = '<tabel></tabel>';
    
  for(var i=0;i<usernames.length;i=i+1){

    let username_copy = usernames[i];
      
    document.getElementById("progress").innerText = ' ' + (i + 1) + ' / ' + usernames.length;
      
    let accounts = await steem.api.getAccountsAsync([username_copy]);
    if(accounts.length == 0) continue;//アカウントなし
    let account_copy = { ...accounts[0] };
      
    let ownerHistory = await steem.api.getOwnerHistoryAsync(username_copy);
    let ownerHistory_copy = { ...ownerHistory };
      
    //data.push({'n':usernames[i],'a':accounts[0],'v':ownerHistory}); 
      data.push({'n':username_copy,'a':account_copy,'v':ownerHistory_copy}); 
    //await sleep(1000);//適当な値500ms
  }
  
  console.log(data);
  return data;
}

function clickBtn() {

  let t1 = document.getElementById("text1").value;
  let csv = t1.split(/\n/);//改行で分割する
  
  getAccountInfo(csv).then(result => {
    html = '<table border=1 >';
      //テーブルのヘッダー
    html = html + '<tr>';
    html = html + '<th>Name</th><th>recovery account</th><th>last owner update</th><th>withdraw routes</th><th>last valid time</th><th>Power Down</th>';
    html = html + '</tr>';
    
    for(var i=0;i<result.length;i=i+1){
      html = html + '<tr>';
      html = html + '<td>' + csv[i] + '</td>';
      html = html + '<td>' + result[i].a.recovery_account + '</td>';
      html = html + '<td>';
      console.log(result[i].a.last_owner_update.toString());
      if(result[i].a.last_owner_update.toString() != '1970-01-01T00:00:00'){
        html = html + ConvertDate(result[i].a.last_owner_update);
      }
      html = html + '</td>';
      html = html + '<td>';
      if(result[i].a.withdraw_routes > 0){
        html = html + result[i].a.withdraw_routes;          
      }
      html = html + '</td>';
      html = html + '<td>';
      if(result[i].v.length > 0){
        for(var j=0;j<result[i].v.length;j=j+1){
            html = html + ConvertDate(result[i].v[j].last_valid_time) + "<br/>";
        }
      }
      html = html + '</td>';
      html = html + '<td>';
      if(result[i].a.next_vesting_withdrawal.toString() != '1969-12-31T23:59:59'){
        html = html + '開始'
      }   
      html = html + '</td>';
      html = html + '</tr>';
    }
    html = html + '</table>';
    console.log(html);
    document.getElementById("text").innerHTML = html;
  }).catch(err => {
     console.log('☆');
    console.log(err);
  }); 
}

        </script>
    </head>
    <body>        
        <p>アカウント名を入力してください。</p>
        <textarea id="text1" rows="10" cols="20">support-jp</textarea>
        <br/>
        <input type="button" value="検査する" onclick="clickBtn()" /><a id="progress"></a>
        
        <span id="text"></span>
    </body>
</html>
