<!doctype html>
<html lang="en">
<head>
<title>Steem Price</title>
<meta charset="utf-8">
<link rel="icon" href="favicon_getaccounthistory.ico" id="favicon">
<link rel="stylesheet" type="text/css" href="./feedprice.css">
<script src="https://code.jquery.com/jquery-3.5.0.js"></script>
<script src="https://github.com/steemit/steem-js/releases/download/v0.7.7/steem.min.js"></script>
<script src="./feedprice.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
steem.api.setOptions({url: 'https://api.steemit.com'})

let myChart1;
let csv = [];
function makeTable(records){

	console.log("function makeTable");

	console.log('☆records☆');
	console.log(records);

	csv.length = 0
	//csv.push('日付,価格\n'); 
	//console.log('日付,価格');
	for(var i=records.length-1;i>=0;i=i-1){

		let exchange_rate = records[i][1].op[1].exchange_rate.base.slice(0, -4);;//0.229 SBD
		let publisher = records[i][1].op[1].publisher;
		let timestamp = formatDate(new Date(records[i][1].timestamp + "z"));

		//console.log(timestamp+","+exchange_rate);
		csv.push (timestamp + "," + exchange_rate);
		//日付,PCR 検査陽性者数(単日)
		//2020/1/16,1.0
		//2020/1/17,0.0

	}
	//document.getElementById("text").innerHTML = feedPriceCSV;
	//return feedPriceCSV;
	csv.reverse();
	csv.unshift ('日付,価格\n'); 

	//records.length
	document.getElementById("price").innerHTML = records[0][1].op[1].exchange_rate.base.slice(0, -4);
	
	//チャート
	if(myChart1 != null){myChart1.destroy();}
	let days = 0;
    myChart1 = clickChartBtn('', days, myChart1, 'myChart1', csv, 'STEEM価格', 'rgb(51, 221, 204)');
}


async function aaa(days){

	console.log("function aaa");
	
	//
	let out = [];
	let limit = 100;
	let lastlength = limit;
	let firstValue = -1;
  	let firstTimestamp = new Date();
	let now = new Date();
	//while (lastlength == limit && now.getTime() - firstTimestamp.getTime() <= (86400000 * days)){
	while (firstValue != 0 && now.getTime() - firstTimestamp.getTime() <= (86400000 * days)){
		//limitより小さいfirstValueでエラーになる問題の対応。
		if(firstValue != -1 && firstValue < limit) {
			limit = firstValue;
		}
		let ret = await steem.api.getAccountHistoryAsync(username, firstValue, limit);
		//console.log(ret);		
		firstValue = ret[0][0];
    		firstTimestamp = new Date(ret[0][1].timestamp);
		firstTimestamp.setHours(firstTimestamp.getHours() + 9);
		ret.shift();
		lastlength = ret.length;
		
		for(var i=ret.length-1;i>=0;i=i-1){
			if(now.getTime() - (new Date(ret[i][1].timestamp).getTime() + 3600000 * 9) > (86400000 * days)){
				ret.splice(i,1);
				continue;
				//ret.splice(0, i + 1);//残りの要素を削除
				//break;//すべて処理済
			}

			if(ret[i][1].op[0] != "feed_publish"){ 
				ret.splice(i,1);
				continue;
			}		
			


			if(getReward_feedprice(ret[i])){
				[''].forEach(function(op){
					if(total_count[op] === void 0){
					}else{						
						//
					}
				});

			}
			
			
	
			let timestamp = new Date(ret[i][1].timestamp + "z");
			let termDay = (now - timestamp) / 86400000;
			document.getElementById("progress").innerText = timestamp.toLocaleString() + ' to now' + ' (' + termDay.toFixed(3) + ' days)';
		}
		
		out = ret.concat(out);
	}
	
	console.log(out);
	
	return out;
};

	
let username;
window.onload = function() {
	console.log("window.onload");

	username = document.getElementById("username").value;
	//document.getElementById("username").value = username;
	clickBtn(1);

	clickBtn1(0);
};
	
</script>

</head>

<body>
<div id="tooltip" display="none" style="position: absolute; display: none;"></div>

	<a style="font-size: xx-large">Steem Price</a> <a id="price" style="font-size: xx-large"></a>

	<form action="javascript:clickBtn(1);">
	<table>
	<tr>
	<td>
	<input type="hidden" id="username" size="20" value="yasu.witness">
	<input type="button" value="表示(1日)" onclick="clickBtn(1)" />
	<input type="button" value="(3日)" onclick="clickBtn(3)" />
	<input type="button" value="(7日)" onclick="clickBtn(7)" />
	<input type="button" value="(30日)" onclick="clickBtn(30)" />
	<input type="button" value="(60日)" onclick="clickBtn(60)" />
	</td>
	</tr>
	</table>

	<a id="progress"></a><br/>
	<span id="text"></span>

	<canvas id="myChart1"></canvas>

	</form>
</body>
</html>
