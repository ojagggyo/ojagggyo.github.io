<!doctype html>
<html lang="en">
<head>
<title>Account History</title>
<meta charset="utf-8">
<link rel="icon" href="favicon_getaccounthistory.ico" id="favicon">
<link rel="stylesheet" type="text/css" href="./getaccounthistory.0.18.css">
<script src="https://code.jquery.com/jquery-3.5.0.js"></script>
<script src="https://github.com/steemit/steem-js/releases/download/v0.7.7/steem.min.js"></script>
<script>
    window.jdenticon_config = {
        replaceMode: "observe"
    };
</script>
<script src="https://cdn.jsdelivr.net/npm/jdenticon@3.1.1/dist/jdenticon.min.js" 
	integrity="sha384-l0/0sn63N3mskDgRYJZA6Mogihu0VY3CusdLMiwpJ9LFPklOARUcOiWEIGGmFELx" 
	crossorigin="anonymous"></script> 
<script src="./getaccounthistory.0.18.js"></script>
<script>
steem.api.setOptions({url: 'https://api.steemit.com'})


// ---------- userlink ----------




	
// ---------- ----------	
function getPostingJsonMetadata(username) {
    return new Promise((resolve, reject) => {
        steem.api.getAccounts([username], function(err, response) {
		if (err) reject(err);
		const posting_json_metadata  = response[0].posting_json_metadata ;
		resolve(JSON.parse(posting_json_metadata));
        });          
    });
}
 function postingJsonMetadataAbout(username, id){
	getPostingJsonMetadata(username).then(result => {
		if(result.profile.about){
			document.getElementById(id).text = result.profile.about;
		}
	}).catch(err => {
		console.log(err);
	});	
}

	
	
// ---------- ----------
function makeLine(record){
	let indenticon_type = 'small';//small, large
	let body = '';
	let identicon =  '';
	let time = donokuraimae(record[1].timestamp);
	if(record[1].op[0] == 'vote'){
		const username = document.getElementById("username").value;
		const voter = record[1].op[1].voter;
		const author = record[1].op[1].author;
		const permlink = record[1].op[1].permlink;
		const weight = record[1].op[1].weight;
		identicon =  '<canvas class=small id=' + record[0] + ' width=24 height=24 data-jdenticon-value=' + voter + '></canvas>'; 
		body = (
			voter == username ? 
				voter 
				: 
				'<a href=' + window.location.pathname + '#' + voter + ' target=' + voter  
				+ ' onmouseover=showTooltip(event) onmouseout=hideTooltip(event)'
				+ ' data-username='+ voter
				+ '>' + voter +  '</a>'
			)
			+ (weight >= 0 ? ' upvote' : ' downvote')
			+ (weight >= 0 ? (voter == username ? '' : emoji_upvote) : emoji_downvote)
			+ ' <a href=https://steemit.com/'
			+ '@' + author + '/' + permlink
			+ '>'
			+ ellipsis('@' + author + '/' + permlink) 
			+ '</a>' 
			+ ' (' + weight/100 + '%)';
	}

	return {identicon: identicon, body: body, time: time, type: indenticon_type};
}
		
function makeTable(records){

	console.log('☆records☆');
	console.log(records);
	html = '<table border=0 cellpadding=0 style="background-color: #f1f1f1;">';
	for(var i=records.length-1;i>=0;i=i-1){
		const line = makeLine(records[i]);
		html = html + '<tr style="background-color: #ffffff;">'
			+ '<td>' 
			+ line.identicon 
			+ '<div class=' + line.type + '>'
			+ ' <span class=' + line.type + '>' 
			+ line.body 
			+ '</span>'
			+ (line.type == 'small' ? ' ' : '<br/>')  + '<a class=gary>' + line.time + '</a>'
			+ '</div>'
			+ '</td>'
			+ '</tr>';
	}
	html = html + '</table>';
	console.log(html);
	document.getElementById("text").innerHTML = html;	
}


let globalProperties;
let krwsteem;
let krwsbd;
let krwtrx;
let krwbtc;
let krweth;
async function aaa(days){
	
	//
	let out = [];
	let limit = 100;
	let lastlength = limit;
	let firstValue = -1;
  	let firstTimestamp = new Date();
	let now = new Date();
	//while (lastlength == limit && now.getTime() - firstTimestamp.getTime() <= (86400000 * days)){
	while (firstValue != 0 && now.getTime() - firstTimestamp.getTime() <= (86400000 * days)){
		//limitより小さいfirstValueでエラーになる問題の対応。
		if(firstValue != -1 && firstValue < limit) {
			limit = firstValue;
		}
		let ret = await steem.api.getAccountHistoryAsync(username, firstValue, limit);
		//console.log(ret);		
		firstValue = ret[0][0];
    		firstTimestamp = new Date(ret[0][1].timestamp);
		firstTimestamp.setHours(firstTimestamp.getHours() + 9);
		ret.shift();
		lastlength = ret.length;
		
		for(var i=ret.length-1;i>=0;i=i-1){
			if(now.getTime() - (new Date(ret[i][1].timestamp).getTime() + 3600000 * 9) > (86400000 * days)){
				ret.splice(i,1);
				continue;
				//ret.splice(0, i + 1);//残りの要素を削除
				//break;//すべて処理済
			}
			
			if(getReward(ret[i])){
				['author_reward', 'curation_reward', 'comment_benefactor_reward'].forEach(function(op){
					if(total_count[op] === void 0){
					}else{						
						let s = 
						    (op == "author_reward" ? "Author: " : (op == "curation_reward" ? "Curation: " : "Benefactor: "))
							+ steemAmountFormat(total_steem_payout[op], total_sbd_payout[op], total_sp_payout[op])
							+ krwAmountFormat(0, total_sbd_payout[op], total_sp_payout[op], krwsteem, krwsbd)
							+ '<br/>'
						document.getElementById(op).innerHTML = s;
					}
				});
			}
			
	
			let timestamp = new Date(ret[i][1].timestamp + "z");
			
			let termDay = (now - timestamp) / 86400000;

			document.getElementById("progress").innerText = timestamp.toLocaleString() + ' to now' + ' (' + termDay.toFixed(3) + ' days)';
		}
		
		out = ret.concat(out);
	}
	
	//console.log(out);
	return out;
};

	

window.onload = function() {

	clickBtn(1);
};
	
</script>

</head>

<body>
<div id="tooltip" display="none" style="position: absolute; display: none;"></div>

	<form action="javascript:clickBtn(1);">
	<table>
	<tr>
	<td><canvas id=identicon width="24" height="24" data-jdenticon-value="yasu" style="margin:0px 0px -7px 0px;"></canvas></td>
	<td>
	<input type="text" id="username" size="20" value="" oninput="inputChange(event)">
	<input type="button" value="表示(1日)" onclick="clickBtn(1)" />
	<input type="button" value="(3日)" onclick="clickBtn(3)" />
	<input type="button" value="(7日)" onclick="clickBtn(7)" />
	<input type="button" value="(30日)" onclick="clickBtn(30)" />
	<input type="button" value="(60日)" onclick="clickBtn(60)" />
	</td>
	</tr>
	</table>
	</form>
</body>
</html>
