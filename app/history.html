<html>
<head>
<!--<script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>-->
<script src="https://github.com/steemit/steem-js/releases/download/v0.7.7/steem.min.js"></script>
<link rel="stylesheet" href="history.css" type="text/css" />
<script>
	
function getUserName(){
  username = window.location.hash;// #username
  if (username == null || username.trim().length == 0){
      username = "#steemitblog";
  }
  username = username.substr(1);//#を取る
  username = decodeURI(username).trim();//デコード、トリム]
  return username;
}


//DownvotePower
function getDownvotePower(username) {
    return new Promise((resolve, reject) => {
        steem.api.getAccounts([username], function(err, response) {
            if (err) reject(err);
            const current_mana = response[0].voting_manabar.current_mana;
            const downvote_mana = response[0].downvote_manabar.current_mana;
            const downvote_last_update_time = response[0].downvote_manabar.last_update_time;
            const downvote_per = downvote_mana / (current_mana / (response[0].voting_power / 100) / 4);          
            const secondsago = (new Date - new Date(downvote_last_update_time * 1000)) / 1000;
            let vpow = downvote_per * 100 + (10000 * secondsago / 432000);
            resolve(Math.min(vpow / 100, 100).toFixed(2));
            resolve((vpow / 100).toFixed(2));
        });          
    });
}

/*
async function aaa(username){
            return  await getDownvotePower(username);
}
    
function clickBtn(){
	let username = document.getElementById("username").value;
	aaa(username).then(result => {	
        document.getElementById("text").innerText = result + "%";
	}).catch(err => {
		console.log('☆');
		console.log(err);
	});	
}
*/
	
//votingpower
async function getAccountsAsync(username){
  let accounts = await steem.api.getAccountsAsync([username]);
  console.log(accounts);
  if(accounts.length == 0) {return;}
  return accounts[0];
}
	
function votingpower(username){
	getAccountsAsync(username).then(result => {
		document.getElementById("votingpower").value = result.voting_power / 100;
	}).catch(err => {
		//$('#text').css('color','red');
	});
}

window.onload = function() {
	steem.api.setOptions({url: 'https://api.steemit.com'});
	let username = getUserName();
	document.getElementById("username").innerText = '@'+username;
	votingpower(username);
	getDownvotePower(username);
};
	
	
</script>
</head>
<body>
	<h1 id=username>aaa</h1>
	<br/><br/>
	Effective Power <b>1000 SP</b>
	<br/><br/>
	Voting Power
	<progress id=votingpower value=0.0 max = 100 class=votingpower></progress>
	<br/><br/>
	Downvote Power
	<progress value=0.8 class=downvotepower></progress>
	<br/><br/>
	Resource Credits
	<progress value=0.8 class=resourcecredits></progress>
</body>
</html>
